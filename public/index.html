<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>Chatbot M·ªπ Ti√™n ‚Äî Ph·ªèng v·∫•n (Gi·ªçng Ban Mai)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{--primary:#f06b9a;--muted:#666;}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;}
  body{background:linear-gradient(180deg,#f4f6f8 0%,#eef2f6 100%);display:flex;align-items:center;justify-content:center;padding:28px}
  .card{width:460px;max-width:96%;background:#fff;border-radius:14px;box-shadow:0 12px 40px rgba(14,18,30,0.08);padding:18px;text-align:center}
  h1{margin:6px 0;color:var(--primary);font-size:20px}
  p.lead{margin:6px 0 12px;color:var(--muted);font-size:14px}
  .avatar-frame{width:300px;height:300px;border-radius:18px;overflow:hidden;margin:12px auto;position:relative;background-size:cover;background-position:center;transition:transform 0.25s ease}
  .avatar-frame.with-img{background-image:url('/office_bg.jpg')}
  .avatar-frame::after{content:'';position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,0.12),rgba(255,255,255,0.02));pointer-events:none}
  .avatar-wrapper{position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;z-index:2}
  .avatar{width:92%;height:92%;object-fit:cover;border-radius:10px;transition:transform 0.12s ease,filter 0.12s ease}
  .eyes::before,.eyes::after{content:"";position:absolute;top:44%;width:22%;height:6%;background:rgba(0,0,0,0.6);border-radius:50%;opacity:0;transition:opacity 0.12s ease;pointer-events:none}
  .eyes::before{left:30%}.eyes::after{right:30%}
  .avatar-wrapper.blink .eyes::before,.avatar-wrapper.blink .eyes::after{opacity:1}
  .avatar-wrapper.smile .avatar{transform:scale(1.02) translateY(-3px);filter:brightness(1.05)}
  .nameplate{position:absolute;left:50%;bottom:10px;transform:translateX(-50%);background:rgba(0,0,0,0.65);color:#fff;padding:6px 12px;border-radius:999px;font-weight:600;font-size:15px;z-index:3;box-shadow:0 6px 18px rgba(0,0,0,0.18)}
  .controls{display:flex;gap:8px;justify-content:center;margin-top:10px}
  button{background:var(--primary);color:#fff;border:0;border-radius:8px;padding:10px 14px;cursor:pointer}
  button[disabled]{opacity:0.6;cursor:not-allowed}
  .secondary{background:#7a8a98;padding:10px 12px}
  .status{margin-top:10px;color:var(--muted);font-size:13px}
  .log{margin-top:12px;text-align:left;background:#fafafa;border-radius:8px;padding:10px;max-height:160px;overflow:auto;font-size:14px}
  .log div{margin-bottom:8px} .log strong{color:#222;margin-right:6px}
  @media (max-width:520px){.avatar-frame{width:240px;height:240px}}
</style>
</head>

<body onclick="try{new Audio().play().catch(()=>{})}catch(e){}">
  <div class="card">
    <h1>Chatbot HR ‚Äî M·ªπ Ti√™n üíº</h1>
    <p class="lead">Ph·ªèng v·∫•n nh√¢n s·ª± ‚Äî b·∫±ng ti·∫øng Vi·ªát (Gi·ªçng Ban Mai)</p>

    <div id="avatarFrame" class="avatar-frame with-img">
      <div class="avatar-wrapper" id="avatarWrap">
        <img id="avatar" class="avatar" src="avatar_hr.png" alt="M·ªπ Ti√™n" />
        <div class="eyes"></div>
        <div class="nameplate">M·ªπ Ti√™n ‚Äî Nh√¢n s·ª±</div>
      </div>
    </div>

    <div class="controls">
      <button id="startBtn">üéôÔ∏è B·∫Øt ƒë·∫ßu ph·ªèng v·∫•n</button>
      <button id="stopBtn" disabled class="secondary">‚èπ D·ª´ng</button>
    </div>

    <div class="status" id="statusText">Nh·∫•n "B·∫Øt ƒë·∫ßu ph·ªèng v·∫•n" ƒë·ªÉ kh·ªüi ƒë·ªông.</div>
    <div class="log" id="chatLog" aria-live="polite"></div>
  </div>

<!-- === SCRIPT === -->
<script>
document.addEventListener("DOMContentLoaded", () => {

const QUESTIONS = [
  "Ch√†o b·∫°n, h√¥m nay b·∫°n th·∫ø n√†o?",
  "T√¥i th·∫•y b·∫°n th∆∞·ªùng ƒë·∫øn h·ªçp h∆°i tr·ªÖ v√†i ph√∫t. B·∫°n nghƒ© sao v·ªÅ ƒëi·ªÅu n√†y?",
  "T√¥i ƒë√£ gi√∫p b·∫°n ho√†n th√†nh ph·∫ßn b√†i c·ªßa b·∫°n r·ªìi ƒë√≥.",
  "C·∫£m ∆°n b·∫°n v√¨ cu·ªôc trao ƒë·ªïi h√¥m nay."
];

let current = 0, recognition = null, isRunning = false, firstGreetingDone = false;

const statusEl = document.getElementById('statusText');
const chatLog = document.getElementById('chatLog');
const avatarWrap = document.getElementById('avatarWrap');
const avatarFrame = document.getElementById('avatarFrame');

function appendLog(who, text){ 
  const d=document.createElement('div'); 
  d.innerHTML=`<strong>${who}:</strong> ${text}`; 
  chatLog.appendChild(d); 
  chatLog.scrollTop=chatLog.scrollHeight; 
}
function setStatus(t){ statusEl.textContent=t; }

/* ==== AUDIO ==== */
async function speakServer(msg){
  return new Promise(async (resolve) => {
    try{
      if (!msg || msg.trim().length < 2) return resolve();
      if (recognition && isRunning) recognition.stop();

      const r = await fetch('/api/tts',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({text:msg})
      });
      if(r.ok){
        const b=await r.blob();
        const url=URL.createObjectURL(b);
        const audio=new Audio(url);
        audio.volume=1.0;
        audio.onended=()=>{URL.revokeObjectURL(url);resolve();};
        audio.onerror=()=>resolve();
        await audio.play().catch(()=>setStatus("Nh·∫•n ƒë·ªÉ b·∫≠t ti·∫øng üéß"));
      } else resolve();
    }catch(e){console.error("üí• L·ªói TTS:",e);resolve();}
  });
}

/* ==== GPT ==== */
async function getGPTReply(userInput){
  try{
    const r=await fetch('/api/chat',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({message:userInput,contextIndex:current})
    });
    const j=await r.json();
    return j.reply||'C·∫£m ∆°n b·∫°n nh√©!';
  }catch(e){return "Xin l·ªói, c√≥ l·ªói k·∫øt n·ªëi.";}
}

/* ==== ANIM ==== */
function startAutoBlink(){
  setInterval(()=>{
    avatarWrap.classList.add('blink');
    setTimeout(()=>avatarWrap.classList.remove('blink'),160);
  },3000+Math.random()*1000);
}
function playSpeakingAnimation(){
  avatarWrap.classList.add('smile');
  avatarFrame.style.transform='translateY(-4px) scale(1.01)';
  setTimeout(()=>{
    avatarWrap.classList.remove('smile');
    avatarFrame.style.transform='';
  },1200);
}

/* ==== SPEECH ==== */
function initRecognition(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ voice. D√πng Chrome.");return null;}
  const r=new SR(); r.lang='vi-VN'; r.interimResults=false; r.maxAlternatives=1;
  r.onstart=()=>setStatus("üé§ ƒêang nghe...");
  r.onerror=e=>setStatus("Kh√¥ng nghe r√µ, n√≥i l·∫°i nh√©!");
  r.onend=()=>{ if(isRunning) setStatus("‚è≥ ƒêang x·ª≠ l√Ω..."); };

  r.onresult=async e=>{
    const userText=e.results[0][0].transcript.trim();
    appendLog("B·∫°n",userText);
    setStatus("üß† ƒêang t·∫°o ph·∫£n h·ªìi...");
    playSpeakingAnimation();

    const reply=await getGPTReply(userText);
    appendLog("M·ªπ Ti√™n",reply);
    await speakServer(reply);

    // üéØ N·∫øu ƒë√¢y l√† ph·∫£n h·ªìi ƒë·∫ßu ti√™n sau l·ªùi ch√†o
    if(!firstGreetingDone){
      firstGreetingDone=true;
      await new Promise(res=>setTimeout(res,1500));
      appendLog("M·ªπ Ti√™n",QUESTIONS[current]);
      await speakServer(QUESTIONS[current]);
      if(isRunning && recognition) recognition.start();
      return;
    }

    // üîÅ H·ªèi c√°c c√¢u ti·∫øp theo
    current++;
    if(current<QUESTIONS.length){
      await new Promise(res=>setTimeout(res,1500));
      appendLog("M·ªπ Ti√™n",QUESTIONS[current]);
      await speakServer(QUESTIONS[current]);
      if(isRunning && recognition) recognition.start();
    }else{
      // ‚úÖ PH·∫¶N CH√ÄO K·∫æT TH√öC
      const goodbyeText = "R·∫•t vui ƒë∆∞·ª£c tr√≤ chuy·ªán c√πng b·∫°n h√¥m nay. C·∫£m ∆°n b·∫°n ƒë√£ d√†nh th·ªùi gian cho bu·ªïi ph·ªèng v·∫•n. Ch√∫c b·∫°n m·ªôt ng√†y th·∫≠t vui v·∫ª v√† nhi·ªÅu nƒÉng l∆∞·ª£ng nh√©!";
      appendLog("M·ªπ Ti√™n",goodbyeText);
      await speakServer(goodbyeText);

      setStatus("‚úÖ K·∫øt th√∫c ph·ªèng v·∫•n.");
      isRunning=false;
    }
  };
  return r;
}

/* ==== START ==== */
document.getElementById('startBtn').onclick=async()=>{
  if(isRunning)return;
  isRunning=true;current=0;firstGreetingDone=false;chatLog.innerHTML="";
  recognition=initRecognition();

  appendLog("M·ªπ Ti√™n","Xin ch√†o, t√¥i l√† M·ªπ Ti√™n, ph·ª• tr√°ch nh√¢n s·ª±. R·∫•t vui ƒë∆∞·ª£c g·∫∑p b·∫°n h√¥m nay!");
  playSpeakingAnimation();
  await speakServer("Xin ch√†o, t√¥i l√† M·ªπ Ti√™n, ph·ª• tr√°ch nh√¢n s·ª±. R·∫•t vui ƒë∆∞·ª£c g·∫∑p b·∫°n h√¥m nay!");

  recognition.start(); // üîä Ch·ªù ng∆∞·ªùi d√πng tr·∫£ l·ªùi
};

document.getElementById('stopBtn').onclick=()=>{
  if(recognition)recognition.stop();
  isRunning=false;
  setStatus("ƒê√£ d·ª´ng.");
};

startAutoBlink();

});
</script>
</body>
</html>
